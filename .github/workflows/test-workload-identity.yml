name: Test Workload Identity

on:
  workflow_dispatch:  # Manual trigger

jobs:
  test-oidc:
    runs-on: self-hosted  # Use self-hosted runner

    permissions:
      id-token: write   # Required for OIDC token
      contents: read

    steps:
      - name: Get OIDC Token
        id: oidc
        run: |
          # Get GitHub OIDC token
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/${{ github.repository_owner }}" | jq -r '.value')
          echo "oidc_token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Got OIDC token (first 50 chars): ${TOKEN:0:50}..."

      - name: Exchange for Bytebase Token
        id: exchange
        run: |
          # Exchange OIDC token for Bytebase access token
          # API: POST /v1/auth:exchangeToken
          # audience format: projects/{project}/locations/global/workloadIdentityPools/{pool}/providers/{provider}
          AUDIENCE="projects/aowuaowu/locations/global/workloadIdentityPools/github-actions/providers/github"

          RESPONSE=$(curl -s -X POST "http://localhost:8080/v1/auth:exchangeToken" \
            -H "Content-Type: application/json" \
            -d "{\"token\": \"${{ steps.oidc.outputs.oidc_token }}\", \"audience\": \"$AUDIENCE\"}")

          echo "Exchange response: $RESPONSE"

          ACCESS_TOKEN=$(echo $RESPONSE | jq -r '.accessToken')
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Test Bytebase API
        run: |
          # Use the token to call Bytebase API
          echo "Testing Bytebase API with access token..."
          curl -s -H "Authorization: Bearer ${{ steps.exchange.outputs.access_token }}" \
            "http://localhost:8080/v1/projects"
